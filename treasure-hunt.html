<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寻宝大冒险 - 增强版</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f0f8f0;
        }
        .log-container {
            border: 1px solid #ccc;
            padding: 15px;
            min-height: 400px;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .log-entry {
            margin: 8px 0;
            padding: 10px;
            border-radius: 4px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .timestamp {
            color: #666;
            font-size: 0.8em;
            margin-right: 10px;
        }
        .delay {
            color: #9c27b0;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .success {
            background-color: #e6f7e6;
            border-left: 3px solid #4caf50;
        }
        .info {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        .warning {
            background-color: #fff8e1;
            border-left: 3px solid #ffc107;
        }
        .error {
            background-color: #ffebee;
            border-left: 3px solid #f44336;
        }
        .event-special {
            background-color: #f3e5f5;
            border-left: 3px solid #9c27b0;
            animation: pulse 1.5s infinite;
        }
        button {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0b7dda;
        }
        .status-bar {
            margin: 15px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-weight: bold;
        }
        .choice-container {
            border: 2px dashed #ff9800;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #fff3e0;
        }
        .choice-btn {
            margin: 5px;
            padding: 8px 15px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .choice-btn:hover {
            background-color: #f57c00;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .treasure-animation {
            animation: treasureGlow 2s ease-in-out;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
        }
        @keyframes treasureGlow {
            0% { background-color: #e6f7e6; }
            50% { background-color: #ffd700; }
            100% { background-color: #e6f7e6; }
        }
    </style>
</head>
<body>
    <h1>寻宝大冒险 - 增强版</h1>
    <p>点击下方按钮开始你的寻宝之旅，体验随机事件，雇佣打手，寻找传说中的宝藏！</p>
    <div class="status-bar">
        状态: 未开始 | 金币: 0 | 打手: 0人 | 特殊状态: 无
    </div>
    <button onclick="startAdventure()">开始探险</button>
    <div class="log-container" id="logContainer"></div>

    <script>
        // 游戏配置 - 集中管理游戏参数，便于调整平衡性
        const gameConfig = {
            initialGold: 60,           // 初始金币
            baseHireSuccess: 0.4,      // 基础雇佣成功率（从0.3提高到0.4）
            hireSuccessPerHelper: 0.1, // 每名打手增加的成功率
            trapProbability: 0.25,     // 陷阱概率（从0.3降低到0.25）
            baseSearchSuccess: 0.35,   // 基础搜索成功率
            guardBaseProbability: 0.5, // 遇到守卫的基础概率
            maxHireAttempts: 5,        // 最大雇佣尝试次数
            helperCost: 5              // 雇佣单名打手的成本
        };

        // 玩家状态 - 记录游戏过程中的各种状态
        let playerState = {
            gold: 0,
            helperCount: 0,
            totalHired: 0,
            hasMap: false,      // 是否获得地图
            hasEquipment: false, // 是否获得装备
            luckBoost: 0        // 运气加成
        };

        // 记录步骤开始时间，用于计算耗时
        let stepStartTime;
        
        // 模拟宝藏地图API - 核心游戏逻辑
        class TreasureMap {
            // 获取初始线索
            static getInitialClue() {
                return new Promise((resolve) => {
                    const delay = 1000;
                    setTimeout(() => {
                        resolve({
                            message: "在古老的图书馆里找到了第一个线索...",
                            delay: delay
                        });
                    }, delay);
                });
            }
        
            // 解码古代文字
            static decodeAncientScript(clue) {
                return new Promise((resolve, reject) => {
                    const delay = 1500;
                    setTimeout(() => {
                        if (!clue) {
                            reject({
                                message: "没有线索可以解码!",
                                delay: delay
                            });
                        }
                        resolve({
                            message: "解码成功!宝藏在一座古老的神庙中...",
                            delay: delay
                        });
                    }, delay);
                });
            }

            // 尝试雇佣打手
            static tryHireHelper() {
                return new Promise((resolve) => {
                    const delay = 1000;
                    setTimeout(() => {
                        resolve({
                            cost: gameConfig.helperCost,
                            delay: delay
                        });
                    }, delay);
                });
            }

            // 检查陷阱
            static checkTrap(helperCount, hasEquipment) {
                return new Promise((resolve) => {
                    const delay = 800;
                    setTimeout(() => {
                        // 基础陷阱概率，如果有装备则降低概率
                        let trapProb = gameConfig.trapProbability;
                        if (hasEquipment) {
                            trapProb *= 0.5; // 装备减少50%陷阱概率
                        }
                        
                        const triggered = Math.random() < trapProb;
                        
                        if (triggered) {
                            // 陷阱损失：1-3人，最多不超过当前人数
                            let maxLoss = hasEquipment ? 2 : 3; // 装备减少最大损失
                            const lost = Math.min(Math.floor(Math.random() * maxLoss) + 1, helperCount);
                            resolve({ 
                                triggered: true, 
                                lost: lost,
                                delay: delay
                            });
                        } else {
                            resolve({ 
                                triggered: false, 
                                lost: 0,
                                delay: delay
                            });
                        }
                    }, delay);
                });
            }
        
            // 搜索神庙
            static searchTemple(helperCount, hasMap, luckBoost) {
                return new Promise((resolve, reject) => {
                    const delay = 2000;
                    setTimeout(() => {
                        // 计算成功率：基础35% + 10%×打人数 + 地图加成 + 运气加成
                        let successRate = gameConfig.baseSearchSuccess + (helperCount * 0.1);
                        if (hasMap) successRate += 0.2; // 地图增加20%成功率
                        successRate += luckBoost * 0.05; // 运气加成
                        
                        // 计算惊动守卫概率：基础50% + 2%×打人数，上限80%
                        const guardProbability = Math.min(
                            gameConfig.guardBaseProbability + (helperCount * 0.02), 
                            0.8
                        );
                        const encounteredGuard = Math.random() < guardProbability;

                        if (encounteredGuard) {
                            // 遇到守卫时成功率稍微降低
                            const guardSuccessRate = successRate * 0.9;
                            resolve({
                                type: "guard",
                                success: Math.random() < guardSuccessRate,
                                message: Math.random() < guardSuccessRate ? 
                                    "成功击退守卫，找到了一个神秘的箱子..." : 
                                    "遭遇守卫袭击，探险失败!",
                                delay: delay
                            });
                        } else {
                            // 没惊动守卫，直接寻找
                            const findBox = Math.random() < successRate;
                            resolve({
                                type: "normal",
                                success: findBox,
                                message: findBox ? 
                                    "顺利找到一个神秘的箱子..." : 
                                    "搜寻了很久，没有找到任何东西...",
                                delay: delay
                            });
                        }
                    }, delay);
                });
            }
        
            // 打开宝箱
            static openTreasureBox(helperCount, gold) {
                return new Promise((resolve, reject) => {
                    const delay = 1000;
                    setTimeout(() => {
                        // 计算额外报酬：每人5金币
                        const bonus = helperCount * 5;
                        
                        if (gold >= bonus) {
                            // 成功打开宝箱的动画效果
                            resolve({
                                message: "恭喜!你找到了传说中的宝藏!",
                                remainingGold: gold - bonus,
                                bonusPaid: bonus,
                                delay: delay
                            });
                        } else {
                            reject({
                                message: `由于无法支付${bonus}金币的额外报酬，打手们瓜分了宝藏!`,
                                delay: delay
                            });
                        }
                    }, delay);
                });
            }
        }

        // 随机事件系统 - 新增功能，增加游戏趣味性
        class RandomEvents {
            // 遇到商人事件
            static encounterMerchant(gold) {
                return new Promise((resolve) => {
                    const delay = 1200;
                    setTimeout(() => {
                        // 商人随机提供三种商品
                        const offers = [
                            { 
                                type: "藏宝图", 
                                cost: 15, 
                                description: "提高搜索成功率20%",
                                effect: "map" 
                            },
                            { 
                                type: "探险装备", 
                                cost: 20, 
                                description: "减少陷阱概率和损失",
                                effect: "equipment" 
                            },
                            { 
                                type: "幸运护符", 
                                cost: 10, 
                                description: "暂时提升运气",
                                effect: "luck" 
                            }
                        ];
                        const offer = offers[Math.floor(Math.random() * offers.length)];
                        resolve({ 
                            type: "merchant",
                            offer: offer,
                            delay: delay 
                        });
                    }, delay);
                });
            }
            
            // 发现废弃营地事件
            static findAbandonedCamp() {
                return new Promise((resolve) => {
                    const delay = 800;
                    setTimeout(() => {
                        const foundGold = Math.floor(Math.random() * 15) + 5; // 5-19金币
                        resolve({ 
                            type: "camp",
                            message: `发现废弃营地，找到${foundGold}金币！`,
                            gold: foundGold,
                            delay: delay
                        });
                    }, delay);
                });
            }
            
            // 遇到旅行者事件
            static meetTraveler() {
                return new Promise((resolve) => {
                    const delay = 1000;
                    setTimeout(() => {
                        // 旅行者可能提供帮助或误导
                        const isHelpful = Math.random() < 0.7; // 70%概率提供正确信息
                        if (isHelpful) {
                            resolve({
                                type: "traveler",
                                message: "遇到一位友善的旅行者，他告诉你一条安全的小路",
                                effect: "safePath", // 下个陷阱检查必然安全
                                delay: delay
                            });
                        } else {
                            resolve({
                                type: "traveler",
                                message: "遇到一位神秘的旅行者，他的建议似乎不太可靠...",
                                effect: "mislead", // 下个陷阱检查概率增加
                                delay: delay
                            });
                        }
                    }, delay);
                });
            }
        }

        // 选择系统 - 让玩家参与决策
        function createChoice(question, options) {
            return new Promise((resolve) => {
                const choiceDiv = document.createElement('div');
                choiceDiv.className = 'choice-container';
                choiceDiv.innerHTML = `
                    <div style="margin-bottom: 10px; font-weight: bold;">${question}</div>
                    ${options.map((option, index) => 
                        `<button class="choice-btn" onclick="resolveChoice(${index})">${option}</button>`
                    ).join('')}
                `;
                document.getElementById('logContainer').appendChild(choiceDiv);
                
                // 全局函数用于处理选择
                window.resolveChoice = (index) => {
                    choiceDiv.remove();
                    resolve(index);
                };
            });
        }

        // 用async/await重写寻宝过程 - 主游戏逻辑
        async function findTreasureWithHelpers() {
            // 初始化状态
            resetGameState();
            
            log("开始寻宝之旅...", "info");
            updateStatus("探索中", playerState.gold, playerState.helperCount);
            
            try {
                // 第一步：获取初始线索
                const clueResult = await TreasureMap.getInitialClue();
                log(clueResult.message, "success", clueResult.delay);

                // 第二步：解码线索
                const decodeResult = await TreasureMap.decodeAncientScript(clueResult.message);
                log(decodeResult.message, "success", decodeResult.delay);

                // 第三步：随机事件 - 30%概率遇到商人
                if (Math.random() < 0.3) {
                    await handleMerchantEvent();
                }

                // 第四步：雇佣打手（最多5次尝试）
                await hireHelpers();

                // 第五步：随机事件 - 40%概率发现废弃营地
                if (Math.random() < 0.4) {
                    await handleCampEvent();
                }

                // 第六步：随机事件 - 25%概率遇到旅行者
                if (Math.random() < 0.25) {
                    await handleTravelerEvent();
                }

                // 第七步：前往神庙途中，检查是否有陷阱
                await checkForTraps();

                // 第八步：搜索神庙
                await searchTemple();

                // 第九步：打开宝箱（支付最终报酬）
                await openTreasureBox();

                // 第十步：游戏总结
                showGameSummary(true);

            } catch (error) {
                log(`任务失败: ${error.message || error}`, "error");
                updateStatus("探险失败", playerState.gold, playerState.helperCount);
                showGameSummary(false);
            }
        }

        // 处理商人事件
        async function handleMerchantEvent() {
            log("途中遇到一个神秘的商人...", "event-special");
            const merchantResult = await RandomEvents.encounterMerchant(playerState.gold);
            
            const question = `商人出售${merchantResult.offer.type} - ${merchantResult.offer.description}，价格: ${merchantResult.offer.cost}金币。你要购买吗？`;
            const choice = await createChoice(question, ["购买", "不购买"]);
            
            if (choice === 0 && playerState.gold >= merchantResult.offer.cost) {
                playerState.gold -= merchantResult.offer.cost;
                // 应用商品效果
                switch(merchantResult.offer.effect) {
                    case "map":
                        playerState.hasMap = true;
                        log(`购买了${merchantResult.offer.type}，现在搜索成功率提高了！`, "success", merchantResult.delay);
                        break;
                    case "equipment":
                        playerState.hasEquipment = true;
                        log(`购买了${merchantResult.offer.type}，现在更安全了！`, "success", merchantResult.delay);
                        break;
                    case "luck":
                        playerState.luckBoost = 2; // 两次运气加成
                        log(`购买了${merchantResult.offer.type}，感觉运气变好了！`, "success", merchantResult.delay);
                        break;
                }
                updateStatus("购买物品", playerState.gold, playerState.helperCount);
            } else if (choice === 0) {
                log("金币不足，无法购买...", "warning", merchantResult.delay);
            } else {
                log("决定不购买商人的商品", "info", merchantResult.delay);
            }
        }

        // 处理营地事件
        async function handleCampEvent() {
            const campResult = await RandomEvents.findAbandonedCamp();
            playerState.gold += campResult.gold;
            log(campResult.message, "event-special", campResult.delay);
            updateStatus("发现营地", playerState.gold, playerState.helperCount);
        }

        // 处理旅行者事件
        async function handleTravelerEvent() {
            const travelerResult = await RandomEvents.meetTraveler();
            log(travelerResult.message, "info", travelerResult.delay);
            
            // 这里可以扩展旅行者事件的效果
            if (travelerResult.effect === "safePath") {
                // 下一个陷阱检查必然安全（简化实现）
                log("沿着旅行者指示的安全小路前进", "success");
            } else if (travelerResult.effect === "mislead") {
                log("感觉这条路不太对劲...", "warning");
            }
        }

        // 雇佣打手逻辑
        async function hireHelpers() {
            log(`你现在有${playerState.gold}金币，开始雇佣打手（最多${gameConfig.maxHireAttempts}次尝试）...`, "info");
            
            for (let i = 0; i < gameConfig.maxHireAttempts; i++) {
                // 检查是否还能雇佣
                if (playerState.gold < gameConfig.helperCost) break;
                
                // 成功率计算：基础40% + 10%×当前打人数
                const successRate = gameConfig.baseHireSuccess + (playerState.helperCount * gameConfig.hireSuccessPerHelper);
                log(`尝试雇佣第${i+1}次（当前${playerState.helperCount}人，成功率: ${Math.round(successRate * 100)}%）...`, "info");
                
                const hireResult = await TreasureMap.tryHireHelper();
                
                // 根据成功率判断是否雇佣成功
                if (Math.random() < successRate) {
                    playerState.helperCount++;
                    playerState.totalHired++;
                    playerState.gold -= hireResult.cost;
                    log(`成功雇佣1名打手！当前共有${playerState.helperCount}名打手，剩余金币: ${playerState.gold}`, "success", hireResult.delay);
                    updateStatus("雇佣中", playerState.gold, playerState.helperCount);
                } else {
                    log("雇佣失败，这个人不愿意加入...", "info", hireResult.delay);
                }
            }

            log(`恭喜你！组成了一个${playerState.helperCount}人的探险团，大家都斗志昂扬，继续前进吧`, "success");
            updateStatus("前往神庙", playerState.gold, playerState.helperCount);
        }

        // 检查陷阱逻辑
        async function checkForTraps() {
            log("正在前往神庙的路上...", "info");
            const trapResult = await TreasureMap.checkTrap(playerState.helperCount, playerState.hasEquipment);
            
            if (trapResult.triggered) {
                playerState.helperCount -= trapResult.lost;
                log(`遭遇陷阱！失去${trapResult.lost}名打手，剩余${playerState.helperCount}人`, "warning", trapResult.delay);
                updateStatus("遭遇陷阱", playerState.gold, playerState.helperCount);
            } else {
                log("安全抵达神庙入口，没有遇到陷阱", "success", trapResult.delay);
            }

            // 如果打手全部损失，独自行动
            if (playerState.helperCount <= 0) {
                log("没有打手了，只能独自进入神庙...", "warning");
            }
        }

        // 搜索神庙逻辑
        async function searchTemple() {
            const searchResult = await TreasureMap.searchTemple(
                playerState.helperCount, 
                playerState.hasMap, 
                playerState.luckBoost
            );
            log(searchResult.message, searchResult.success ? "success" : "error", searchResult.delay);
            
            if (!searchResult.success) {
                throw new Error(searchResult.message);
            }
            
            // 消耗一次运气加成
            if (playerState.luckBoost > 0) {
                playerState.luckBoost--;
            }
            
            updateStatus("发现宝箱", playerState.gold, playerState.helperCount);
        }

        // 打开宝箱逻辑
        async function openTreasureBox() {
            const treasureResult = await TreasureMap.openTreasureBox(playerState.helperCount, playerState.gold);
            
            // 添加宝藏找到的特殊效果
            const treasureLog = log(treasureResult.message, "success", treasureResult.delay);
            document.getElementById('logContainer').lastChild.classList.add('treasure-animation');
            
            log(`支付了${treasureResult.bonusPaid}金币报酬，剩余金币: ${treasureResult.remainingGold}`, "info");
            playerState.gold = treasureResult.remainingGold;
            updateStatus("寻宝成功", playerState.gold, playerState.helperCount);
        }

        // 显示游戏总结
        function showGameSummary(success) {
            if (success) {
                log("=== 探险成功总结 ===", "success");
                log(`总共雇佣${playerState.totalHired}人，最终存活${playerState.helperCount}人`, "info");
                log(`剩余金币: ${playerState.gold}`, "info");
                if (playerState.hasMap) log("✓ 使用了藏宝图", "success");
                if (playerState.hasEquipment) log("✓ 使用了探险装备", "success");
            } else {
                log("=== 探险失败总结 ===", "error");
                log(`总共尝试雇佣${playerState.totalHired}人`, "info");
                log(`剩余金币: ${playerState.gold}`, "info");
            }
            
            // 提示重玩信息
            log("点击\"开始探险\"按钮可以重新开始游戏", "info");
        }

        // 重置游戏状态
        function resetGameState() {
            playerState = {
                gold: gameConfig.initialGold,
                helperCount: 0,
                totalHired: 0,
                hasMap: false,
                hasEquipment: false,
                luckBoost: 0
            };
        }

        // 日志输出函数（带时间戳和延迟信息，突出异步特性）
        function log(message, type = "success", delay = 0) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            
            // 获取当前时间并格式化
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            logEntry.className = `log-entry ${type}`;
            let delayText = delay > 0 ? `<span class="delay">(${delay/1000}s)</span>` : '';
            logEntry.innerHTML = `<span class="timestamp">[${timeString}]</span>${message}${delayText}`;
            logContainer.appendChild(logEntry);
            
            // 自动滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // 同时输出到控制台
            if (type === "error") {
                console.error(`[${timeString}] ${message}`);
            } else {
                console.log(`[${timeString}] ${message}`);
            }
            
            return logEntry;
        }

        // 更新状态条
        function updateStatus(status, gold, helpers) {
            let specialStatus = "";
            if (playerState.hasMap) specialStatus += "藏宝图 ";
            if (playerState.hasEquipment) specialStatus += "装备 ";
            if (playerState.luckBoost > 0) specialStatus += "幸运 ";
            if (!specialStatus) specialStatus = "无";
            
            document.querySelector('.status-bar').textContent = 
                `状态: ${status} | 金币: ${gold} | 打手: ${helpers}人 | 特殊状态: ${specialStatus}`;
        }

        // 开始冒险
        function startAdventure() {
            // 禁用按钮防止重复点击
            document.querySelector('button').disabled = true;
            // 清空之前的日志
            document.getElementById('logContainer').innerHTML = '';
            // 开始寻宝
            findTreasureWithHelpers().then(() => {
                // 寻宝结束后重新启用按钮
                document.querySelector('button').disabled = false;
            });
        }
    </script>
</body>
</html>